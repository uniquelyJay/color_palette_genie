<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Color Palette Genie ¬∑ Cozy Color Club</title>
<style>
:root{
  --bg-top:#f1e9ff;
  --bg-bottom:#ffffff;
  --card:#ffffff;
  --ink:#1f1a33;
  --muted:#7a7394;
  --accent:#c6a6ff;
  --accent-soft:#efe6ff;
  --gold:#d9b27c;
  --shadow:0 10px 26px rgba(35,22,70,0.12);
  --radius:18px;
  --radius-s:12px;
  --transition:0.18s ease;
  --sparkle:#e7d4ff;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{
  min-height:100vh;
  padding:22px 16px 26px;
  font-family:-apple-system,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  color:var(--ink);
  background:linear-gradient(to bottom,var(--bg-top),var(--bg-bottom));
  display:flex;
  justify-content:center;
}
.app{
  width:100%;
  max-width:1120px;
}
.app-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:10px;
  margin-bottom:14px;
}
.title-wrap{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.brand-line{
  display:flex;
  align-items:baseline;
  gap:8px;
}
.brand-main{
  font-size:22px;
  font-weight:700;
  letter-spacing:0.02em;
}
.brand-badge{
  font-size:11px;
  padding:3px 9px;
  border-radius:999px;
  background:rgba(0,0,0,0.02);
  color:var(--gold);
  border:1px solid rgba(217,178,124,0.4);
  font-weight:600;
}
.subtitle{
  font-size:11px;
  color:var(--muted);
}
.powered{
  font-size:9px;
  color:var(--muted);
}
.actions-top{
  display:flex;
  flex-direction:column;
  align-items:flex-end;
  gap:6px;
}
.btn-mini{
  font-size:9px;
  padding:4px 8px;
  border-radius:999px;
  border:1px solid rgba(198,166,255,0.7);
  background:rgba(255,255,255,0.9);
  color:#6c56b3;
  cursor:pointer;
}
.btn-mini:hover{
  background:var(--accent-soft);
}
.layout{
  display:grid;
  grid-template-columns:minmax(0,2.1fr) minmax(230px,0.9fr);
  gap:14px;
}
.card{
  background:var(--card);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:12px 11px 11px;
  border:1px solid rgba(215,205,255,0.8);
}
.controls{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  align-items:center;
  margin-bottom:6px;
}
.label{
  font-size:9px;
  color:var(--muted);
  display:flex;
  align-items:center;
  gap:4px;
}
.input, .select{
  padding:5px 8px;
  border-radius:999px;
  border:1px solid rgba(198,166,255,0.9);
  font-size:9px;
  outline:none;
  background:#fdfbff;
  color:var(--ink);
}
.btn{
  padding:6px 11px;
  border-radius:999px;
  border:none;
  font-size:10px;
  font-weight:600;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  transition:var(--transition);
  white-space:nowrap;
}
.btn.primary{
  background:var(--accent);
  color:#fff;
  box-shadow:0 8px 16px rgba(129,103,209,0.3);
}
.btn.primary:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 20px rgba(129,103,209,0.35);
}
.btn.ghost{
  background:#ffffff;
  color:#6a5bb5;
  border:1px solid rgba(198,166,255,0.9);
}
.btn.ghost:hover{
  background:var(--accent-soft);
}
.palette-wrap{
  margin-top:6px;
  position:relative;
  padding:6px;
  border-radius:var(--radius);
  background:linear-gradient(to bottom,rgba(246,241,255,0.9),rgba(255,255,255,1));
  overflow:hidden;
}
.sparkles{
  pointer-events:none;
  position:absolute;
  inset:0;
  opacity:0;
  transition:opacity 0.3s ease-out;
}
.sparkles.active{
  opacity:1;
}
.sparkle-dot{
  position:absolute;
  width:3px;
  height:3px;
  border-radius:999px;
  background:var(--sparkle);
  animation:sparkle 0.8s ease-out forwards;
}
@keyframes sparkle{
  0%{transform:scale(0.2);opacity:0;}
  35%{transform:scale(1);opacity:1;}
  100%{transform:scale(0.1);opacity:0;}
}
.swatches{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(90px,1fr));
  gap:8px;
}
.swatch{
  background:#fff;
  border-radius:var(--radius-s);
  padding:6px;
  border:1px solid rgba(223,214,255,0.95);
  box-shadow:0 6px 14px rgba(40,24,82,0.06);
  display:flex;
  flex-direction:column;
  gap:4px;
  position:relative;
}
.swatch-color{
  height:40px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,0.08);
  cursor:pointer;
  transition:transform var(--transition), box-shadow var(--transition);
}
.swatch-color:hover{
  transform:translateY(-1px);
  box-shadow:0 6px 10px rgba(0,0,0,0.12);
}
.swatch-meta{
  font-size:8px;
  color:var(--muted);
  display:flex;
  flex-direction:column;
  gap:1px;
}
.swatch-code{
  font-weight:700;
  color:#5b4ac6;
}
.lock-btn{
  position:absolute;
  top:4px;
  right:4px;
  padding:2px 6px;
  font-size:8px;
  border-radius:999px;
  border:1px solid rgba(214,204,255,0.9);
  background:#ffffffee;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:2px;
  color:#7a6ad1;
}
.lock-btn.locked{
  background:#ffe7bd;
  border-color:#e7b869;
  color:#7a4c16;
}
.harmony-line{
  margin-top:4px;
  font-size:8px;
  color:var(--muted);
  display:flex;
  justify-content:space-between;
  gap:6px;
  align-items:center;
}
.output{
  width:100%;
  margin-top:4px;
  font-size:8px;
  padding:5px 6px;
  border-radius:10px;
  border:1px solid rgba(215,205,255,0.9);
  background:#fdfbff;
  resize:none;
  height:40px;
}
.tags{
  margin-top:4px;
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.tag{
  padding:2px 6px;
  border-radius:999px;
  background:#f4efff;
  color:#7467c0;
  font-size:8px;
  border:1px solid rgba(212,201,255,0.9);
}
.side{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.side-title{
  font-size:10px;
  font-weight:600;
  color:#4b3b98;
  margin-bottom:2px;
}
.side-text{
  font-size:8px;
  color:var(--muted);
  line-height:1.5;
}
input[type=file]{
  width:100%;
  margin-top:4px;
  padding:5px;
  border-radius:10px;
  font-size:8px;
  border:1px dashed rgba(186,166,255,0.9);
  background:#fbf9ff;
}
.side-box{
  margin-top:2px;
  padding:5px;
  border-radius:var(--radius-s);
  background:#fbf9ff;
  border:1px solid rgba(226,218,255,0.9);
  font-size:8px;
  color:var(--muted);
  max-height:120px;
  overflow:auto;
}
.side-btns{
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  margin-top:4px;
}
@media (max-width:768px){
  .layout{grid-template-columns:1fr;}
  .app-header{flex-direction:column;align-items:flex-start;}
  .actions-top{align-items:flex-start;}
}
</style>
</head>
<body>
<div class="app">
  <header class="app-header">
    <div class="title-wrap">
      <div class="brand-line">
        <div class="brand-main">Color Palette Genie</div>
        <div class="brand-badge">Cozy Color Club</div>
      </div>
      <div class="subtitle">‚ú® Manifest Your Mood ¬∑ Cohesive palettes for cozy coloring & content.</div>
      <div class="powered">Powered by Ohuhu 216 ¬∑ Names, codes & vibes built-in.</div>
    </div>
    <div class="actions-top">
      <button class="btn-mini" id="btnInstall">üì≤ Download Palette Genie</button>
      <div class="side-text">On iPhone: Share ‚Üí ‚ÄúAdd to Home Screen‚Äù for a one-tap Genie.</div>
    </div>
  </header>

  <main class="layout">
    <section class="card">
      <div class="controls">
        <div class="label">
          Size
          <input id="size" class="input" type="number" min="3" max="8" value="5" />
        </div>
        <div class="label">
          Vibe
          <select id="vibe" class="select">
            <option value="balanced">Balanced</option>
            <option value="pastel">Pastel</option>
            <option value="warm">Warm</option>
            <option value="cool">Cool</option>
            <option value="earthy">Earthy</option>
            <option value="neutrals">Cozy Neutrals</option>
          </select>
        </div>
        <button class="btn primary" id="btnGenerate">‚ú® Generate Palette</button>
        <button class="btn ghost" id="btnClearLocks">üîì Clear Locks</button>
      </div>
      <div class="controls">
        <button class="btn ghost" id="btnCopy">üìã Copy Codes</button>
        <button class="btn ghost" id="btnCSV">‚¨áÔ∏è Export CSV</button>
        <button class="btn ghost" id="btnImage">üñºÔ∏è Save as Image</button>
      </div>

      <div class="palette-wrap">
        <div class="sparkles" id="sparkles"></div>
        <div class="swatches" id="swatches"></div>
        <div class="harmony-line">
          <div id="harmonyLabel">Harmony: ‚Äî</div>
          <div id="vibeLabel">Vibe: Balanced</div>
        </div>
      </div>

      <textarea id="output" class="output" readonly></textarea>
      <div class="tags" id="tags"></div>
    </section>

    <aside class="side">
      <div class="card">
        <div class="side-title">How to use your Genie</div>
        <div class="side-text">
          1) Pick a vibe ¬∑ 2) Set size (3‚Äì8) ¬∑ 3) Tap <b>Generate</b>.<br/>
          Lock any swatch you love, then re-roll around it for variations.<br/>
          Tap a color block to nudge it closer to your real marker swatch.
        </div>
      </div>

      <div class="card">
        <div class="side-title">Upload custom set (optional)</div>
        <div class="side-text">
          Upload a CSV with: <code>family,code,name,hex</code> to override or extend.
        </div>
        <input type="file" id="fileInput" accept=".csv" />
        <div class="side-box" id="previewBox"></div>
      </div>

      <div class="card">
        <div class="side-title">Recent palettes</div>
        <div class="side-text" id="recentInfo">
          Your last palettes are saved on this device. Generating will refresh this list.
        </div>
        <div class="side-box" id="recentBox"></div>
      </div>
    </aside>
  </main>
</div>

<script>
const rawList = `
Y02 LemonChiffon
Y03 PastelYellow
Y06 Butter
Y07 BananaCream
Y08 Pineapple
Y09 SummerLemon
Y14 PaleLemon
Y17 BrightLemon
Y19 Canary
Y111 Mustard
Y26 LightGold
Y27 Sunflower
Y28 CornYellow
Y29 MelonYellow
Y210 PumpkinYel
Y211 DeepYellow
Y213 DarkMarigold
Y214 SweetPotato
Y215 Toffee
Y216 Caramel
Y34 Eggnog
Y37 LightWheat
Y39 Straw
Y310 GoldSatin
Y311 TermiteBg
Y315 OliveYel
Y42 WarmIvory
Y43 WarmBeige
Y45 Cream
Y46 PeachYogurt
Y48 LtApricot
Y49 AutumnLeaf
Y410 Goldenrod
Y411 EggshellBr
Y412 AppleCider
Y413 Fawn
Y415 SandStorm
Y416 GoldenBr
Y55 GoldChamp
Y56 Milkshake
Y57 UnblTitan
Y59 Marigold
Y515 LtWalnut
Y516 Walnut
Y62 SandyBeige
Y66 AlmondCrm
Y68 LtMilkTea
Y69 MilkTea
Y610 Sand
Y611 DarkSand
Y613 TwineBg
Y615 OliveWood
YR00 BareBlush
YR02 PeachSilk
YR03 PastelBlsh
YR04 PastelPch
YR05 CottonPearl
YR06 RawCashew
YR07 SalmonOrg
YR09 Sandstone
YR014 TuscanOrg
YR015 BurntOrg
YR11 PeachyBlsh
YR17 SunsetOrg
YR19 MarigoldOrg
YR110 LtOrange
YR111 Persimmon
YR112 Orange
YR114 DeepSunset
YR115 BloodOrg
YR25 PowderOrg
YR27 PeachCob
YR28 Apricot
YR29 Grapefruit
YR213 SquashOrg
YR214 Terracotta
YR215 AgedCherry
YR33 RoseCream
YR34 PeachCream
YR36 OrangePie
YR37 RoastCash
YR38 BurntOchre
YR39 Cinnamon
YR310 LtToffee
YR312 LtEarth
YR313 PotatoBr
YR314 Sandalwood
YR316 Hazelnut
YR43 PaleCherry
YR44 PaleComplex
YR45 Rosewater
YR47 DustyPeach
YR52 CameoRose
YR54 PinkFrost
YR55 PinkLemon
YR56 LtApriPink
YR57 TropPeach
YR58 PinkSand
YR59 Cantaloupe
YR510 SpicySalmon
YR511 PaleCoral
YR513 Papaya
YR515 BurntSien
E03 PaleSage
E05 PaleMoss
E06 BogMist
E011 PaleCamo
E13 Limestone
E14 KhakiBg
E17 SageGrey
E19 DriedSage
E111 PewterGr
E22 LimeJuice
E26 PaleCelery
E211 LtElm
E212 DustyOlive
E215 DarkKhaki
E30 FrenchGy
E36 OldSalem
E311 Sandbar
E312 Fennel
E313 SwampMud
E314 MilOlive
E315 Vandyke
E44 SoftSand
E46 CoralSand
E47 Camel
E49 HoneyBr
E411 Tumbleweed
E413 DarkBr
E415 CedarBr
E57 Cappuccino
E58 FawnBr
E59 Chestnut
E511 ChocMoch
E512 Espresso
E513 TaupeBr
E514 DarkChoc
E515 BlackBr
E64 LtTaupe
E66 LtFawn
E69 RussetBr
E610 LtMahog
E612 BrickBr
E613 RedBr
E614 Maple
E615 CherryCola
E75 LtRoseTp
E710 CopperBr
E711 OldMahog
E712 SweetRosy
E713 RedBean
E714 MadderBr
E81 SpanPink
E85 CherryTp
E814 CaputMort
E92 AshRose
E93 RosyGy
E97 DeepRoseGy
E912 Hearth
E913 Walnut
E914 Bark
E915 DarkBark
R012 FruitPunch
R013 Tomato
R014 DpVermil
R015 Crimson
R016 ChiliRed
R12 PaleCoral
R14 SheerPeach
R15 Lychee
R16 LtSalmon
R17 BabyPink
R19 AmsRose
R111 HotPink
R112 RedPink
R114 Scarlet
R22 Ballet
R23 Sakura
R25 TenderPk
R26 Valentine
R27 PinkSatin
R28 PinkCarn
R210 DeepBlush
R211 Ruby
R212 Mulberry
R213 Pomegran
R214 Cranberry
R215 Morello
R38 RosePink
R310 PurpPink
R312 Magenta
R46 OldRose
R48 CherryRose
R410 Raspberry
R412 Cerise
R413 Amaranth
R414 LtMaroon
R50 OrchidWisp
R54 LavFog
R56 Puce
R57 RoseDust
R58 Garnet
R59 WineBerry
R510 WineRed
R513 DeepWine
R514 Prune
R515 FrRoast
R68 DeepMauve
R69 DarkMauve
R612 Raisin
R613 BurgBark
R615 BlackGrape
RV01 WaterLily
RV04 LtOrchid
RV05 PinkPearl
RV08 PastelPk
RV09 DiscoPk
RV17 Pink
RV18 Bubblegum
RV19 Dahlia
RV111 HotPk
RV23 PinkWisp
RV24 DullPk
RV25 RosyLilac
RV27 OrchidPk
RV28 Hibiscus
RV29 PlumPk
RV210 RedViolet
RV211 Dragonfruit
RV212 RichRasp
RV31 LilacMist
RV32 LilacBlsh
RV33 Thistle
RV34 FadedLilac
RV35 BrightLilac
RV39 BrightFuch
RV310 Fuschia
RV311 Pansy
RV313 DkPansy
RV314 GrapeJc
RV315 DeepPansy
RV316 GrapeJelly
RV45 PlumBloss
RV53 Lilac
RV57 DarkLilac
RV58 DeepLilac
RV514 ViolMerlot
RV515 RipeMullb
V07 SmokyLav
V08 LtViolet
V09 VintagePurp
V010 FadedVio
V013 Violet
V015 DeepVio
V016 Eggplant
V12 DustyOrch
V13 GreydLav
V14 PalePurp
V15 Wisteria
V18 BrightLav
V112 VividVio
V22 LavWisp
V23 PaleLav
V24 EvePetunia
V25 VioletRose
V29 DullVio
V214 Purple
V216 MorningGl
V32 IcyPeri
V33 LavMist
V34 Periwinkle
V35 LavSilk
V38 DeepPeri
V46 Lavender
V411 LavIndigo
V412 Lobella
V413 BlueVio
V414 ElecIndigo
V416 DeepPurp
BV03 PowderBlue
BV04 LtCornflower
BV05 Cornflower
BV08 Havelock
BV09 DpCornfl
BV013 FrUltra
BV014 Ultra
BV015 DpUltra
BV15 DustyPeri
BV18 Hydrangea
BV19 BlueIris
BV115 ShadowBl
BV26 PaleBV
BV27 Bluebell
BV28 Bluebonnet
BV29 Iris
BV210 Blueberry
BV31 CloudBlue
BV32 PaleSky
BV34 IceBlue
BV35 Arctic
BV37 Glacier
BV38 SkyBlue
BV310 BrillBlue
BV311 RoyalBlue
BV312 DpRoyal
BV314 Lapis
BV315 Cobalt
BV316 Prussian
BV48 DistDenim
BV414 DenimBl
BV415 Antwerp
BV58 CrystalBl
BV59 SummerSky
BV514 VintageNvy
BV515 Navy
B02 LtMintBl
B03 Frost
B05 RobinEgg
B06 LtCerulean
B07 LtBlue
B08 CandyBlue
B09 TahitiBlue
B010 BlueLagoon
B015 CeladonBl
B111 PoolBlue
B112 ProcessBl
B114 Cerulean
B115 ClassicBl
B21 Porcelain
B27 FogBlue
B28 SmokeBlue
B310 BlueDusk
B311 StoneBlue
B315 DeepCerul
B411 RichSlate
B412 Gunmetal
B415 StormNight
BG04 SeaSpray
BG05 LtSeaBl
BG09 Aqua
BG010 Peacock
BG011 Teal
BG19 SeaBlue
BG114 FadedTeal
BG115 DarkTeal
BG21 MintWisp
BG22 MintMist
BG24 SeaGlass
BG211 Spearmint
BG212 PineGrn
BG213 ParrotGrn
BG215 DKPine
BG310 Seafoam
BG311 Turquoise
BG312 DpTurq
BG313 LakeGrn
BG314 PeacGrn
BG315 Castleton
G012 MineralGrn
G013 MutedTurq
G112 PaleCobGrn
G113 DustyJade
G114 AgedPine
G24 Celadon
G29 FadedGrn
G210 SeaGrn
G213 Rainforest
G215 DarkGrn
G34 PaleGrn
G36 GlassGrn
G310 Shamrock
G311 JadeGrn
G312 Emerald
G313 Green
G315 DkEmerald
G316 DeepJade
G41 Peppermint
G43 VintPaleGrn
G44 SeaGlassGrn
G47 SpringGrn
G48 Lettuce
G49 SourApple
G410 GrassGrn
YG06 Sugarcane
YG07 Honeydew
YG012 YellowGrn
YG013 Chartreuse
YG014 Matcha
YG015 DarkOlive
YG111 Celery
YG112 LemLime
YG113 PearGrn
YG114 OliveGrn
YG29 AppleGrn
YG211 Edamame
YG212 Guac
YG215 Thatch
YG36 BeigeGrn
YG312 Artichoke
YG313 CamoGrn
YG413 FernGrn
YG414 DKFern
YG415 Cascade
YG510 BudGrn
YG66 FreshGrn
YG610 BrightLime
YG611 MantisGrn
`;

function parseDataset(raw){
  const lines = raw.trim().split('\n');
  const out = [];
  for(const line of lines){
    const parts = line.trim().split(/\s+/);
    if(!parts[0]) continue;
    const code = parts[0];
    const name = parts.slice(1).join(' ');
    const famMatch = code.match(/^[A-Z]+/);
    out.push({
      code,
      name,
      fam: famMatch ? famMatch[0] : '',
      hex: ''
    });
  }
  return out;
}

let dataset = parseDataset(rawList);
const FAMILY_ORDER = ["R","YR","Y","YG","G","BG","B","BV","V","RV","E"];

function getFamily(code){
  const m = code.match(/^[A-Z]+/);
  return m ? m[0] : '';
}

function baseHexForFamily(f){
  switch(f){
    case "Y": return "#f5d46a";
    case "YR":return "#f0a45b";
    case "R": return "#e46b6f";
    case "RV":return "#e68ac0";
    case "V": return "#b28adf";
    case "BV":return "#7b8ee6";
    case "B": return "#5fa8e8";
    case "BG":return "#4ab9b0";
    case "G": return "#5da976";
    case "YG":return "#a3c86a";
    case "E": return "#9a7660";
    default: return "#bfbfbf";
  }
}

function getSavedHexMap(){
  try{
    return JSON.parse(localStorage.getItem("cpg_hex_overrides")||"{}");
  }catch(e){return {};}
}
function saveHex(code,hex){
  try{
    const map = getSavedHexMap();
    map[code] = hex;
    localStorage.setItem("cpg_hex_overrides",JSON.stringify(map));
  }catch(e){}
}
function getHexForColor(item){
  const map = getSavedHexMap();
  if(map[item.code]) return map[item.code];
  if(item.hex) return item.hex;
  return baseHexForFamily(item.fam);
}

function vibeFilter(v){
  if(v==="pastel"){
    return c => /0$/.test(c.code) || /0[1-4]$/.test(c.code);
  }
  if(v==="warm"){
    return c => ["R","RV","YR","Y","E"].includes(c.fam);
  }
  if(v==="cool"){
    return c => ["YG","G","BG","B","BV","V"].includes(c.fam);
  }
  if(v==="earthy"){
    return c => ["E","YR","Y","YG"].includes(c.fam);
  }
  if(v==="neutrals"){
    return c => c.fam==="E";
  }
  return () => true;
}

function chooseHarmony(){
  const modes = ["Analogous","Complementary","Triadic"];
  return modes[Math.floor(Math.random()*modes.length)];
}

function familiesForHarmony(seedFam, harmony){
  const order = FAMILY_ORDER;
  const idx = order.indexOf(seedFam);
  if(idx===-1) return [seedFam || "Y"];
  const wrap = i => order[(i+order.length)%order.length];
  if(harmony==="Analogous"){
    return [wrap(idx-1), seedFam, wrap(idx+1)];
  }
  if(harmony==="Complementary"){
    return [seedFam, wrap(idx+5)];
  }
  if(harmony==="Triadic"){
    return [seedFam, wrap(idx+4), wrap(idx+8)];
  }
  return [seedFam];
}

function pickFromFamily(fam, filter, used){
  const pool = dataset.filter(d => d.fam===fam && filter(d) && !used.has(d.code));
  if(pool.length===0) return null;
  return pool[Math.floor(Math.random()*pool.length)];
}

function getLocked(){
  const out = [];
  const used = new Set();
  document.querySelectorAll(".swatch").forEach(sw=>{
    const btn = sw.querySelector(".lock-btn");
    if(btn && btn.classList.contains("locked")){
      const code = sw.getAttribute("data-code");
      const item = dataset.find(d=>d.code===code);
      if(item && !used.has(item.code)){
        out.push(item);
        used.add(item.code);
      }
    }
  });
  return {locked:out, used};
}

let lastPalette = [];
let lastHarmony = "‚Äî";
let lastVibe = "balanced";

function generatePalette(){
  const sizeInput = document.getElementById("size");
  let n = parseInt(sizeInput.value,10);
  if(isNaN(n) || n<3) n=3;
  if(n>8) n=8;
  sizeInput.value = n;

  const vibe = document.getElementById("vibe").value;
  lastVibe = vibe;
  const filter = vibeFilter(vibe);

  const {locked, used} = getLocked();
  let seed = locked.length ? locked[0] : null;
  if(!seed){
    const pool = dataset.filter(d=>d.fam && d.fam!=="");
    seed = pool[Math.floor(Math.random()*pool.length)] || dataset[0];
  }
  const seedFam = seed.fam || getFamily(seed.code);
  const harmony = chooseHarmony();
  lastHarmony = harmony;
  const fams = familiesForHarmony(seedFam, harmony);

  const result = [...locked];
  for(const it of locked) used.add(it.code);

  let i=0;
  while(result.length < n && i < 400){
    const fam = fams[i % fams.length];
    let pick = pickFromFamily(fam, filter, used);
    if(!pick) pick = pickFromFamily(fam, ()=>true, used);
    if(pick){
      result.push(pick);
      used.add(pick.code);
    }
    i++;
  }
  if(result.length===0 && dataset.length){
    result.push(dataset[0]);
  }
  lastPalette = result.slice(0,n);
  renderPalette();
  pushRecent(lastPalette, lastHarmony, vibe);
  runSparkles();
}

function runSparkles(){
  const wrap = document.getElementById("sparkles");
  wrap.innerHTML = "";
  const rect = wrap.getBoundingClientRect();
  const count = 14;
  for(let i=0;i<count;i++){
    const dot = document.createElement("div");
    dot.className = "sparkle-dot";
    const x = Math.random()*100;
    const y = 8 + Math.random()*70;
    dot.style.left = x+"%";
    dot.style.top = y+"%";
    wrap.appendChild(dot);
  }
  wrap.classList.add("active");
  setTimeout(()=>{wrap.classList.remove("active");},350);
}

function renderPalette(){
  const container = document.getElementById("swatches");
  const tags = document.getElementById("tags");
  const out = document.getElementById("output");
  const harmonyEl = document.getElementById("harmonyLabel");
  const vibeEl = document.getElementById("vibeLabel");

  container.innerHTML = "";
  tags.innerHTML = "";

  harmonyEl.textContent = "Harmony: " + (lastHarmony || "‚Äî");
  const vibeLabel = {
    balanced:"Balanced",
    pastel:"Pastel Soft",
    warm:"Warm Glow",
    cool:"Cool Mist",
    earthy:"Earthy Cozy",
    neutrals:"Cozy Neutrals"
  }[lastVibe] || "Balanced";
  vibeEl.textContent = "Vibe: " + vibeLabel;

  const codes = lastPalette.map(p=>p.code).join(", ");
  out.value = codes;

  lastPalette.forEach(item=>{
    const sw = document.createElement("div");
    sw.className = "swatch";
    sw.setAttribute("data-code", item.code);

    const colorDiv = document.createElement("div");
    colorDiv.className = "swatch-color";
    colorDiv.style.background = getHexForColor(item);
    colorDiv.addEventListener("click",()=>pickColor(item, colorDiv));
    sw.appendChild(colorDiv);

    const meta = document.createElement("div");
    meta.className = "swatch-meta";
    const codeSpan = document.createElement("div");
    codeSpan.className = "swatch-code";
    codeSpan.textContent = item.code;
    const nameSpan = document.createElement("div");
    nameSpan.textContent = item.name;
    meta.appendChild(codeSpan);
    meta.appendChild(nameSpan);
    sw.appendChild(meta);

    const lockBtn = document.createElement("button");
    lockBtn.className = "lock-btn";
    lockBtn.innerHTML = "üîì";
    lockBtn.addEventListener("click",()=>{
      lockBtn.classList.toggle("locked");
      lockBtn.innerHTML = lockBtn.classList.contains("locked") ? "üîí" : "üîì";
    });
    sw.appendChild(lockBtn);

    container.appendChild(sw);

    const tag = document.createElement("div");
    tag.className = "tag";
    tag.textContent = item.code + " ¬∑ " + item.name;
    tags.appendChild(tag);
  });
}

function pickColor(item, node){
  const input = document.createElement("input");
  input.type = "color";
  input.value = rgbToHex(window.getComputedStyle(node).backgroundColor);
  input.style.position = "fixed";
  input.style.left = "-9999px";
  document.body.appendChild(input);
  input.addEventListener("input",()=>{
    node.style.backgroundColor = input.value;
  });
  input.addEventListener("change",()=>{
    saveHex(item.code, input.value);
  });
  input.click();
  setTimeout(()=>document.body.removeChild(input),0);
}

function rgbToHex(rgb){
  const m = rgb.match(/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,[^)]+)?\)$/);
  if(!m) return "#ffffff";
  const r = parseInt(m[1],10).toString(16).padStart(2,"0");
  const g = parseInt(m[2],10).toString(16).padStart(2,"0");
  const b = parseInt(m[3],10).toString(16).padStart(2,"0");
  return "#"+r+g+b;
}

document.getElementById("btnGenerate").addEventListener("click", generatePalette);
document.getElementById("btnClearLocks").addEventListener("click", ()=>{
  document.querySelectorAll(".lock-btn").forEach(b=>{
    b.classList.remove("locked");
    b.innerHTML = "üîì";
  });
});
document.getElementById("btnCopy").addEventListener("click", ()=>{
  const text = document.getElementById("output").value;
  if(navigator.clipboard && text){
    navigator.clipboard.writeText(text);
  }else{
    const t = document.getElementById("output");
    t.select();
    document.execCommand("copy");
  }
});
document.getElementById("btnCSV").addEventListener("click", ()=>{
  if(!lastPalette.length) return;
  const lines = ["code,name,hex"];
  lastPalette.forEach(p=>{
    lines.push([p.code, p.name, getHexForColor(p)].join(","));
  });
  const blob = new Blob([lines.join("\n")],{type:"text/csv"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "color_palette_genie.csv";
  a.click();
});
document.getElementById("btnImage").addEventListener("click", ()=>{
  if(!lastPalette.length) return;
  const size = 1080;
  const canvas = document.createElement("canvas");
  canvas.width = size;
  canvas.height = size;
  const ctx = canvas.getContext("2d");
  ctx.fillStyle = "#ffffff";
  ctx.fillRect(0,0,size,size);
  const title = "Color Palette Genie";
  const subtitle = "Cozy Color Club ¬∑ Ohuhu Inspired";
  ctx.fillStyle = "#1f1a33";
  ctx.font = "bold 40px -apple-system,system-ui,sans-serif";
  ctx.fillText(title, 60, 120);
  ctx.font = "22px -apple-system,system-ui,sans-serif";
  ctx.fillStyle = "#7a7394";
  ctx.fillText(subtitle, 60, 160);
  const count = lastPalette.length;
  const swWidth = (size-160)/count;
  const swTop = 260;
  const swHeight = 360;
  lastPalette.forEach((p,i)=>{
    const x = 60 + i*swWidth;
    const hex = getHexForColor(p);
    ctx.fillStyle = hex;
    ctx.strokeStyle = "#e5e5e5";
    ctx.lineWidth = 4;
    ctx.beginPath();
    const r = 26;
    roundRect(ctx,x,swTop,swWidth-20,swHeight,r);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = "#1f1a33";
    ctx.font = "bold 24px -apple-system,system-ui,sans-serif";
    ctx.fillText(p.code, x+18, swTop+swHeight+40);
    ctx.font = "18px -apple-system,system-ui,sans-serif";
    ctx.fillStyle = "#7a7394";
    const label = p.name;
    ctx.fillText(label, x+18, swTop+swHeight+70);
  });
  ctx.font = "18px -apple-system,system-ui,sans-serif";
  ctx.fillStyle = "rgba(217,178,124,0.95)";
  const wm = "Cozy Color Club";
  const textWidth = ctx.measureText(wm).width;
  ctx.fillText(wm, size-60-textWidth, size-40);
  const link = document.createElement("a");
  link.href = canvas.toDataURL("image/png");
  link.download = "color_palette_genie.png";
  link.click();
});

function roundRect(ctx,x,y,w,h,r){
  ctx.beginPath();
  ctx.moveTo(x+r,y);
  ctx.lineTo(x+w-r,y);
  ctx.quadraticCurveTo(x+w,y,x+w,y+r);
  ctx.lineTo(x+w,y+h-r);
  ctx.quadraticCurveTo(x+w,y+h,x+w-r,y+h);
  ctx.lineTo(x+r,y+h);
  ctx.quadraticCurveTo(x,y+h,x,y+h-r);
  ctx.lineTo(x,y+r);
  ctx.quadraticCurveTo(x,y,x+r,y);
  ctx.closePath();
}

document.getElementById("fileInput").addEventListener("change", e=>{
  const f = e.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = () => {
    const text = reader.result.trim();
    const lines = text.split(/\r?\n/);
    const header = lines.shift().split(",").map(s=>s.trim().toLowerCase());
    const fi = header.indexOf("family");
    const ci = header.indexOf("code");
    const ni = header.indexOf("name");
    const hi = header.indexOf("hex");
    const tmp = [];
    lines.forEach(line=>{
      const parts = line.split(",").map(s=>s.trim());
      if(ci<0 || !parts[ci]) return;
      tmp.push({
        fam: fi>=0?parts[fi]:"",
        code: parts[ci],
        name: ni>=0?parts[ni]:"",
        hex: hi>=0?parts[hi]:"",
      });
    });
    if(tmp.length){
      dataset = tmp;
      document.getElementById("previewBox").textContent =
        "Loaded "+tmp.length+" custom colors.";
      generatePalette();
    }
  };
  reader.readAsText(f);
});

function pushRecent(palette, harmony, vibe){
  try{
    const key = "cpg_recent_palettes";
    const prev = JSON.parse(localStorage.getItem(key) || "[]");
    const simple = {
      time: Date.now(),
      harmony,
      vibe,
      codes: palette.map(p=>p.code)
    };
    prev.unshift(simple);
    const trimmed = prev.slice(0,6);
    localStorage.setItem(key, JSON.stringify(trimmed));
    renderRecent(trimmed);
  }catch(e){}
}

function loadRecent(){
  try{
    const key = "cpg_recent_palettes";
    const prev = JSON.parse(localStorage.getItem(key) || "[]");
    renderRecent(prev);
  }catch(e){}
}

function renderRecent(list){
  const box = document.getElementById("recentBox");
  if(!list || !list.length){
    box.textContent = "Generate palettes to see them saved here.";
    return;
  }
  box.innerHTML = "";
  list.forEach((p,idx)=>{
    const line = document.createElement("div");
    line.style.marginBottom = "3px";
    line.style.cursor = "pointer";
    line.textContent = (idx+1)+") ["+(p.harmony||"‚Äì")+"/"+(p.vibe||"") + "] " + p.codes.join(" ");
    line.addEventListener("click", ()=>{
      const items = p.codes.map(c => dataset.find(d=>d.code===c)).filter(Boolean);
      if(items.length){
        lastPalette = items;
        lastHarmony = p.harmony;
        lastVibe = p.vibe;
        renderPalette();
      }
    });
    box.appendChild(line);
  });
}

document.getElementById("btnInstall").addEventListener("click", ()=>{
  alert("To \"download\" Color Palette Genie:\n1. Open this page in your browser.\n2. Tap Share.\n3. Choose \"Add to Home Screen\".\nNow it lives as a one-tap Cozy Color Club app üíú");
});

loadRecent();
generatePalette();
</script>
</body>
</html>
